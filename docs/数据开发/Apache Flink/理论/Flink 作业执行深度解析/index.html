<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-数据开发/Apache Flink/理论/Flink 作业执行深度解析">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Flink 作业执行深度解析 | 大数据知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhangyongtian.github.io/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Flink 作业执行深度解析 | 大数据知识库"><meta data-rh="true" name="description" content="Flink 四层转化流程"><meta data-rh="true" property="og:description" content="Flink 四层转化流程"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangyongtian.github.io/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析"><link data-rh="true" rel="alternate" href="https://zhangyongtian.github.io/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://zhangyongtian.github.io/en/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangyongtian.github.io/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="大数据知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="大数据知识库 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.c7c4384d.css">
<link rel="preload" href="/assets/js/runtime~main.4dcd1c4b.js" as="script">
<link rel="preload" href="/assets/js/main.d89d1304.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="BigdataKnowledge Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="BigdataKnowledge Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">BigdataKnowledge</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/概览">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zhangyongtian/bigdataknowledge" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/概览">概览</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/开发者指南">开发者指南</a><button aria-label="打开/收起侧边栏菜单「开发者指南」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数仓理论">数仓理论</a><button aria-label="打开/收起侧边栏菜单「数仓理论」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数据质量">数据质量</a><button aria-label="打开/收起侧边栏菜单「数据质量」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数据集成">数据集成</a><button aria-label="打开/收起侧边栏菜单「数据集成」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数据协调">数据协调</a><button aria-label="打开/收起侧边栏菜单「数据协调」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数据调度">数据调度</a><button aria-label="打开/收起侧边栏菜单「数据调度」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/容器调度">容器调度</a><button aria-label="打开/收起侧边栏菜单「容器调度」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/数据存储">数据存储</a><button aria-label="打开/收起侧边栏菜单「数据存储」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/数据开发">数据开发</a><button aria-label="打开/收起侧边栏菜单「数据开发」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/apache-flink">Apache Flink</a><button aria-label="打开/收起侧边栏菜单「Apache Flink」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/理论">理论</a><button aria-label="打开/收起侧边栏菜单「理论」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/概览">概览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/Runtime核心机制">Runtime核心机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/时间属性深度解析">时间属性深度解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/Checkpoint 原理剖析与应用实战">Checkpoint 原理剖析与应用实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/Flink 架构概览">Flink 架构概览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/数据类型和序列化">数据类型和序列化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析">Flink 作业执行深度解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/网络流控及反压剖析">网络流控及反压剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/Apache Flink/理论/End-to-End-Exactly-Once">End-to-End-Exactly-Once</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/实践">实践</a><button aria-label="打开/收起侧边栏菜单「实践」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/apache-paimon">Apache Paimon</a><button aria-label="打开/收起侧边栏菜单「Apache Paimon」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/apache-spark">Apache Spark</a><button aria-label="打开/收起侧边栏菜单「Apache Spark」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/apache-streampark">Apache StreamPark</a><button aria-label="打开/收起侧边栏菜单「Apache StreamPark」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/dinky">Dinky</a><button aria-label="打开/收起侧边栏菜单「Dinky」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/数据开发/概览">概览</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/平台监控">平台监控</a><button aria-label="打开/收起侧边栏菜单「平台监控」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/bi报表">BI报表</a><button aria-label="打开/收起侧边栏菜单「BI报表」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/自动化运维">自动化运维</a><button aria-label="打开/收起侧边栏菜单「自动化运维」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/项目实战案例">项目实战案例</a><button aria-label="打开/收起侧边栏菜单「项目实战案例」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/comminicate">交流与贡献</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/数据开发"><span itemprop="name">数据开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/apache-flink"><span itemprop="name">Apache Flink</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/理论"><span itemprop="name">理论</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Flink 作业执行深度解析</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Flink 作业执行深度解析</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="flink-四层转化流程">Flink 四层转化流程<a href="#flink-四层转化流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>Flink 有 四 层 转 换 流 程， <strong>第 一 层 为 Program 到 StreamGraph； 第 二 层 为 StreamGraph 到 JobGraph；第三层为 JobGraph 到 ExecutionGraph；第四层为 ExecutionGraph 到物理执行计划。</strong>通过对 Program 的执行，能够生成一个 DAG 执行图，即逻辑执行图。如下：</p><p><img loading="lazy" alt="Flink简介" src="/assets/images/fc3394235940354165cfb53790eb3f2-353122f289ff92a34e06d32d13b35782.png" width="1138" height="623" class="img_ev3q"></p><p>第一部分将先讲解四层转化的流程，然后将以详细案例讲解四层的具体转化。</p><ul><li><p>第一层 StreamGraph 从 Source 节点开始，每一次 transform 生成一个 StreamNode， <strong>两 个 StreamNode 通 过 StreamEdge 连 接 在 一 起 , 形 成 StreamNode 和 StreamEdge 构成的 DAG</strong>。</p></li><li><p>第二层 JobGraph，依旧从 Source 节点开始，然后去遍历寻找能够嵌到一起的 operator，如果能够嵌到一起则嵌到一起，不能嵌到一起的单独生成 jobVertex，通过 JobEdge 链接上下游 JobVertex，最终形成 JobVertex 层面的 DAG。</p></li><li><p>JobVertex DAG 提交到任务以后，从 Source 节点开始排序 , 根据 JobVertex 生 成 ExecutionJobVertex， 根 据 jobVertex 的 IntermediateDataSet 构建 <strong>IntermediateResult，然后 IntermediateResult 构建上下游的依赖关系，形成 ExecutionJobVertex 层面的 DAG 即 ExecutionGraph</strong>。</p></li><li><p>最后通过 ExecutionGraph 层到物理执行层。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="program-到-streamgraph-的转化">Program 到 StreamGraph 的转化<a href="#program-到-streamgraph-的转化" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>Program 转换成 StreamGraph 具体分为三步：</p><ul><li><p>从 StreamExecutionEnvironment.execute 开始执行程序，将 transform 添加到 StreamExecutionEnvironment 的 transformations。</p></li><li><p>调用 StreamGraphGenerator 的 generateInternal 方法，遍历 transformations 构建 StreamNode 及 StreamEage。</p></li><li><p>通过 StreamEdge 连接 StreamNode。</p></li></ul><p><img loading="lazy" alt="Flink简介" src="/assets/images/3ba2be5fbca2c183fb8ae60a92b8b6c-cdfa44e7db98de0f023b620b4c6fab15.png" width="1069" height="592" class="img_ev3q"></p><p>通过 WindowWordCount 来看代码到 StreamGraph 的转化，在 flatMap transform 设置 slot 共享组为 flatMapsg，并发设置为 4，<strong>在聚合的操作中设置 slot 共享组为 sumsg</strong>， sum() 和 counts() 并发设置为 3，这样设置主要是为了演示后面如何嵌到一起的，跟上下游节点的并发以及上游的共享组有关。</p><p>WindowWordCount 代码中可以看到，在 readTextFile() 中会生成一个 transform，且 transform 的 ID 是 1；然后到 flatMap() 会生成一个 transform， transform 的 ID 是 2；接着到 keyBy() 生成一个 transform 的 ID 是 3；再到 sum() 生成一个 transform 的 ID 是 4；最后到 counts() 生成 transform 的 ID 是 5。</p><p><img loading="lazy" alt="Flink简介" src="/assets/images/3e8f70c8e6d3040420ce32fd33c121e-eb7cd22c2541112d2f9edb499f1ff3e5.png" width="1075" height="285" class="img_ev3q"></p><p>transform 的结构如图所示，第一个是 flatMap 的 transform，第二个是 window的 transform， 第 三 个 是 SinkTransform 的 transform。 除 此 之 外， 还 能 在
transform 的结构中看到每个 transform 的 input 是什么。</p><p>接下来介绍一下 StreamNode 和 StreamEdge。</p><ul><li><p>StreamNode 是用来描述 operator 的逻辑节点，其关键成员变量有 slotSharingGroup、jobVertexClass、inEdges、outEdges 以 及 transformationUID。</p></li><li><p>StreamEdge 是用来描述两个 operator 逻辑的链接边，其关键变量有 sourceVertex、targetVertex。</p></li></ul><p><img loading="lazy" alt="Flink简介" src="/assets/images/04f563f68b3d68ff8873696a6acab27-e1003db0e7ad26b4ab82a7d2accff9e3.png" width="854" height="466" class="img_ev3q"></p><p>WindowWordCount transform 到 StreamGraph 转化如图所示，StreamExecutionEnvironment 的 transformations 存在 3 个 transform，分别是 Flat Map
（Id 2）、Window（Id 4）、Sink（Id 5）。</p><p>transform 的时候首先递归处理 transform 的 input，<strong>生成 StreamNode，然后通过 StreamEdge 链接上下游 StreamNode。需要注意的是，有些 transform 操作并不会生成 StreamNode 如 PartitionTransformtion，而是生成个虚拟节点</strong>。</p><p><img loading="lazy" alt="Flink简介" src="/assets/images/379479ed23056b4a613bde01a393de1-577fefe1620a27f1e118157df822408b.png" width="974" height="292" class="img_ev3q"></p><p>在转换完成后可以看到，streamNodes 有四种 transform 形式，分别为 Source、Flat Map、Window、Sink。</p><p><img loading="lazy" alt="Flink简介" src="/assets/images/aedeffc58d8ca9b2b0e748a0fa08e0d-25edb1e6ff1d5248462daddf2e99ed39.png" width="965" height="411" class="img_ev3q"></p><p><strong>每个 streamNode 对象都携带并发个数、slotSharingGroup、执行类等运行信息</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="streamgraph-到-jobgraph-的转化">StreamGraph 到 JobGraph 的转化<a href="#streamgraph-到-jobgraph-的转化" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="Flink简介" src="/assets/images/0c8dbec4ebacc7a51953096700b2719-1da916a9e8a7a5282220ce678620491b.png" width="830" height="593" class="img_ev3q"></p><p>StreamGraph 到 JobGraph 的转化步骤：</p><ul><li><p>设置调度模式，Eager 所有节点立即启动。</p></li><li><p>广度优先遍历 StreamGraph，<strong>为每个 streamNode 生成 byte 数组类型的 hash 值</strong>。</p></li><li><p>从 source 节点开始递归寻找嵌到一起的 operator，不能嵌到一起的节点单独生成 jobVertex，能够嵌到一起的开始节点生成 jobVertex，其他节点以序列化的形式写入到 StreamConfig，然后 merge 到 CHAINEDTASKCONFIG，再通过 JobEdge 链接上下游 JobVertex。</p></li><li><p>将每个 JobVertex 的入边 (StreamEdge) 序列化到该 StreamConfig。</p></li><li><p><strong>根据 group name 为每个 JobVertext 指定 SlotSharingGroup</strong>。</p></li><li><p>配置 checkpoint。</p></li><li><p>将缓存文件存文件的配置添加到 configuration 中。</p></li><li><p>设置 ExecutionConfig。</p></li></ul><p>从 source 节点递归寻找嵌到一起的 operator 中，嵌到一起需要满足一定的条件，具体条件介绍如下：</p><ul><li>下游节点只有一个输入。</li><li>下游节点的操作符不为 null。</li><li>上游节点的操作符不为 null。</li><li>上下游节点在一个槽位共享组内。</li><li>下游节点的连接策略是 ALWAYS。</li><li>上游节点的连接策略是 HEAD 或者 ALWAYS。</li><li>edge 的分区函数是 ForwardPartitioner 的实例。</li><li>上下游节点的并行度相等。</li><li>可以进行节点连接操作。</li></ul><p><img loading="lazy" alt="Flink简介" src="/assets/images/a1221b60c4d01452bdf590bccdf2bc6-9d4ed422fee71a2a9aa1bdc20a49cd45.png" width="1116" height="237" class="img_ev3q"></p><p>JobGraph 对象结构如上图所示，taskVertices 中只存在 Window、Flat Map、Source 三个 TaskVertex，<strong>Sink operator 被嵌到 window operator 中去了</strong>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为什么要为每个-operator-生成-hash-值">为什么要为每个 operator 生成 hash 值？<a href="#为什么要为每个-operator-生成-hash-值" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p>Flink 任务失败的时候，<strong>各个 operator 是能够从 checkpoint 中恢复到失败之前的状态的，恢复的时候是依据 JobVertexID（hash 值 )进行状态恢复的</strong>。<strong>相同的任务在恢复的时候要求 operator 的 hash 值不变，因此能够获取对应的状态</strong>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="每个-operator-是怎样生成-hash-值的">每个 operator 是怎样生成 hash 值的？<a href="#每个-operator-是怎样生成-hash-值的" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p>如果用户对节点指定了一个散列值，<strong>则基于用户指定的值能够产生一个长度为 16 的字节数组</strong>。如果用户没有指定，<strong>则根据当前节点所处的位置，产生一个散列值</strong>。</p><blockquote><p><a href="https://cloud.tencent.com/developer/article/2296239" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/2296239</a></p></blockquote><p>考虑的因素主要有三点：</p><ul><li><p>一是在当前 StreamNode 之前已经处理过的节点的个数，作为当前 StreamNode 的 id，添加到 hasher 中。</p></li><li><p>二 是 遍 历 当 前 StreamNode 输 出 的 每 个 StreamEdge， <strong>并 判 断 当 前 StreamNode 与这个 StreamEdge 的目标 StreamNode 是否可以进行链接，如果可以，则将目标 StreamNode 的 id 也放入 hasher 中，且这个目标 StreamNode 的 id 与当前 StreamNode 的 id 取相同的值</strong>；</p></li><li><p>三 是 将 上 述 步 骤 后 产 生 的 字 节 数 据， 与 当 前 StreamNode 的 所 有 输入StreamNode 对应的字节数据，进行相应的位操作，最终得到的字节据就是当前 StreamNode 对应的长度为 16 的字节数组。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jobgraph-到-exexcutiongraph-以及物理执行计划">JobGraph 到 ExexcutionGraph 以及物理执行计划<a href="#jobgraph-到-exexcutiongraph-以及物理执行计划" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="Flink简介" src="/assets/images/718aed2bccaa5b5c76264e5bcc1857a-dfddbf0d3beb8e51bc1f68593b15b60d.png" width="929" height="603" class="img_ev3q"></p><p>JobGraph 到 ExexcutionGraph 以及物理执行计划的流程：</p><ul><li><p>将 JobGraph 里面的 jobVertex 从 Source 节点开始排序。</p></li><li><p>在 executionGraph.attachJobGraph(sortedTopology) 方 法 里 面，<strong>根 据 JobVertex 生成 ExecutionJobVertex</strong>，在 ExecutionJobVertex 构造方法里面，根据 jobVertex 的 IntermediateDataSet 构建 IntermediateResult，<strong>根 据 jobVertex 并 发 构 建 ExecutionVertex</strong>，ExecutionVertex 构 建 的 时候，构建 IntermediateResultPartition（每一个 Execution 构建 IntermediateResult 数个 IntermediateResultPartition ）；将创建的 ExecutionJobVertex 与置的 IntermediateResult 连接起来。</p></li><li><p>构建 ExecutionEdge ，连接到前面的 IntermediateResultPartition，最终从 ExecutionGraph 到物理执行计划。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="flink-job-执行流程">Flink Job 执行流程<a href="#flink-job-执行流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="flink-on-yarn-模式">Flink On Yarn 模式<a href="#flink-on-yarn-模式" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="Flink简介" src="/assets/images/9e5e49ac93312abb007f1d6d4667678-8a4ed2eab4cba83055da24cdd63b4656.png" width="920" height="473" class="img_ev3q"></p><p>基于 Yarn 层面的架构类似 Spark on Yarn 模式，都是由 Client 提交 App 到 RM 上面去运行，然后 RM 分配第一个 container 去运行 AM，然后由 AM 去负责资源的监督和管理。需要说明的是，Flink 的 Yarn 模式更加类似 Spark on Yarn 的cluster 模式，在 cluster 模式中，dirver 将作为 AM 中的一个线程去运行。</p><p>Flink on Yarn 模 式 也 是 会 将 JobManager 启 动 在 container 里 面， 去 做个 driver 类 似 的 任 务 调 度 和 分 配，Yarn AM 与 Flink JobManager 在 同 一 个 Container 中，<strong>这样 AM 可以知道 Flink JobManager 的地址，从而 AM 可以申请 Container 去启动 Flink TaskManager。待 Flink 成功运行在 Yarn 集群上，Flink Yarn Client 就可以提交 Flink Job 到 Flink JobManager，并进行后续的映射、调度和计算处理</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fink-on-yarn-的缺陷">Fink on Yarn 的缺陷<a href="#fink-on-yarn-的缺陷" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li><p>资源分配是静态的，<strong>一个作业需要在启动时获取所需的资源并且在它的生命周期里一直持有这些资源</strong>。这导致了作业不能随负载变化而动态调整，在负载下降时无法归还空闲的资源，在负载上升时也无法动态扩展。</p></li><li><p>On-Yarn 模式下，<strong>所有的 container 都是固定大小的，导致无法根据作业需求来调整 container 的结构</strong>。譬如 CPU 密集的作业或许需要更多的核，但不需要太多内存，固定结构的 container 会导致内存被浪费。</p></li><li><p>与容器管理基础设施的交互比较笨拙，需要两个步骤来启动 Flink 作业 : </p><ol><li>启动 Flink 守护进程。</li><li>提交作业。如果作业被容器化并且将作业部署作为容器部署的一部分，那么将不再需要步骤 2。</li></ol></li><li><p>On-Yarn 模式下，作业管理页面会在作业完成后消失不可访问。</p></li><li><p>Flink 推荐 per job clusters 的部署方式，但是又支持可以在一个集群上运行多个作业的 session 模式，令人疑惑。</p></li><li><p>在 Flink 版本 1.5 中引入了 Dispatcher，Dispatcher 是在新设计里引入的一个新概念。Dispatcher 会从 Client 端接受作业提交请求并代表它在集群管理器上启动作业。</p></li></ul><p><strong>引入 Dispatcher 的原因主要有两点：</strong></p><ul><li>一些集群管理器需要一个中心化的作业生成和监控实例。</li><li>能够实现 Standalone 模式下 JobManager 的角色，且等待作业提交。在一些案例中，Dispatcher 是可选的 (Yarn) 或者不兼容的 (kubernetes)。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="资源调度模型重构下的-flink-on-yarn-模式">资源调度模型重构下的 Flink On Yarn 模式<a href="#资源调度模型重构下的-flink-on-yarn-模式" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="Flink简介" src="/assets/images/c899a1b71e1678d6d40523946515d3c-e571c49de1dccd94f1fdcb3b6b6b3781.png" width="944" height="612" class="img_ev3q"></p><p><strong>没有 Dispatcher job 运行过程</strong></p><p>客 户 端 提 交 JobGraph 以 及 依 赖 jar 包 到 YarnResourceManager， 接着 Yarn ResourceManager 分 配 第 一 个 container 以 此 来 启 动 AppMaster，Application Master <strong>中会启动一个 FlinkResourceManager 以及 JobManager，JobManager 会根据 JobGraph 生成的 ExecutionGraph 以及物理执行计划向 FlinkResourceManager 申 请 slot</strong>，FlinkResoourceManager 会 管 理 这 些 slot 以及请求，如果没有可用 slot 就向 Yarn 的 ResourceManager 申请 container，container 启动以后会注册到 FlinkResourceManager，最后 JobManager 会将 subTask deploy 到对应 container 的 slot 中去。</p><p><img loading="lazy" alt="Flink简介" src="/assets/images/587b0140d3365d2efc69482a3a1797b-113de1cc210d07e0175ca657c71d55ee.png" width="727" height="473" class="img_ev3q"></p><p><strong>在有 Dispatcher 的模式下</strong></p><p>会增加一个过程，就是 Client 会直接通过 HTTP Server 的方式，然后用 Dispatcher 将这个任务提交到 Yarn ResourceManager 中。</p><p>新框架具有四大优势，详情如下：</p><ul><li>client 直接在 Yarn 上启动作业，而不需要先启动一个集群然后再提交作业到集群。因此 client 再提交作业后可以马上返回。</li><li>所有的用户依赖库和配置文件都被直接放在应用的 classpath，而不是用动态的用户代码 classloader 去加载。</li><li>container 在需要时才请求，不再使用时会被释放。</li><li>“需要时申请”的 container 分配方式允许不同算子使用不同 profile (CPU 和内存结构 ) 的 container。</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhangyongtian/bigdataknowledge/tree/dev/docs/数据开发/Apache Flink/理论/Flink 作业执行深度解析.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/数据开发/Apache Flink/理论/数据类型和序列化"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">数据类型和序列化</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/数据开发/Apache Flink/理论/网络流控及反压剖析"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">网络流控及反压剖析</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#flink-四层转化流程" class="table-of-contents__link toc-highlight">Flink 四层转化流程</a><ul><li><a href="#program-到-streamgraph-的转化" class="table-of-contents__link toc-highlight">Program 到 StreamGraph 的转化</a></li><li><a href="#streamgraph-到-jobgraph-的转化" class="table-of-contents__link toc-highlight">StreamGraph 到 JobGraph 的转化</a></li><li><a href="#jobgraph-到-exexcutiongraph-以及物理执行计划" class="table-of-contents__link toc-highlight">JobGraph 到 ExexcutionGraph 以及物理执行计划</a></li></ul></li><li><a href="#flink-job-执行流程" class="table-of-contents__link toc-highlight">Flink Job 执行流程</a><ul><li><a href="#flink-on-yarn-模式" class="table-of-contents__link toc-highlight">Flink On Yarn 模式</a></li><li><a href="#fink-on-yarn-的缺陷" class="table-of-contents__link toc-highlight">Fink on Yarn 的缺陷</a></li><li><a href="#资源调度模型重构下的-flink-on-yarn-模式" class="table-of-contents__link toc-highlight">资源调度模型重构下的 Flink On Yarn 模式</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/概览">文档</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zhangyongtian/bigdataknowledge" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a href="https://github.com/zhangyongtian/bigdataknowledge" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4dcd1c4b.js"></script>
<script src="/assets/js/main.d89d1304.js"></script>
</body>
</html>